use std::collections::HashMap;

use types::RvmType;

pub mod pipeline;
pub mod reader;
pub mod types;

pub const RVM_HASH_MASK_LE: u64 = 0xffffffffff000000;

pub type RvmBlock = Vec<RvmType>;

pub struct RvmTypeDatabase {
    blocks: HashMap<u64, RvmBlock>,
    blocks_by_type_hash: HashMap<u32, Vec<u64>>,
}

impl RvmTypeDatabase {
    pub fn new() -> Self {
        Self {
            blocks: HashMap::new(),
            blocks_by_type_hash: HashMap::new(),
        }
    }

    pub fn add_block(&mut self, type_hash: u32, hash: u64, rvm_type: RvmBlock) {
        self.blocks.insert(hash, rvm_type);
        self.blocks_by_type_hash
            .entry(type_hash)
            .or_default()
            .push(hash);
    }

    pub fn get_block(&self, hash: u64) -> Option<&RvmBlock> {
        self.blocks.get(&(hash & RVM_HASH_MASK_LE))
    }

    pub fn get_blocks_of_type(&self, type_hash: u32) -> Vec<u64> {
        self.blocks_by_type_hash
            .get(&type_hash)
            .cloned()
            .unwrap_or_default()
    }

    pub fn entries(&self) -> impl Iterator<Item = (&u64, &RvmBlock)> {
        self.blocks.iter()
    }
}

#[cfg(test)]
mod tests {
    use std::hash::Hasher;

    use cityhasher::CityHasher;

    #[test]
    fn test() {
        // let data: [u8; 0x100] = [
        //     0x44, 0x58, 0x42, 0x43, 0x9B, 0x5A, 0x0D, 0xB0, 0x2D, 0x08, 0xBC, 0x1B, 0x79, 0xC6, 0x0A, 0x63,
        //     0xE1, 0x85, 0x2B, 0x5A, 0x01, 0x00, 0x00, 0x00, 0xFC, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
        //     0x2C, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0xB8, 0x00, 0x00, 0x00, 0x49, 0x53, 0x47, 0x4E,
        //     0x50, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00,
        //     0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        //     0x0F, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        //     0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x53, 0x56, 0x5F, 0x50,
        //     0x6F, 0x73, 0x69, 0x74, 0x69, 0x6F, 0x6E, 0x00, 0x54, 0x45, 0x58, 0x43, 0x4F, 0x4F, 0x52, 0x44,
        //     0x00, 0xAB, 0xAB, 0xAB, 0x4F, 0x53, 0x47, 0x4E, 0x2C, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        //     0x08, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        //     0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x53, 0x56, 0x5F, 0x54,
        //     0x61, 0x72, 0x67, 0x65, 0x74, 0x00, 0xAB, 0xAB, 0x53, 0x48, 0x45, 0x58, 0x3C, 0x00, 0x00, 0x00,
        //     0x50, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x6A, 0x08, 0x00, 0x01, 0x65, 0x00, 0x00, 0x03,
        //     0xF2, 0x20, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x00, 0x00, 0x08, 0xF2, 0x20, 0x10, 0x00,
        //     0x00, 0x00, 0x00, 0x00, 0x02, 0x40, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3F, 0x00, 0x00, 0x80, 0x3F,
        //     0x00, 0x00, 0x80, 0x3F, 0x00, 0x00, 0x80, 0x3F, 0x3E, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        // ];

        let data: [u8; 0x50] = [
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x93, 0x1F, 0x37, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x93, 0x74, 0x28, 0xCE, 0xE1, 0x5E, 0x00, 0x00, 0xC3, 0x9F,
            0xF5, 0xAB, 0x3B, 0x4E, 0x00, 0x00, 0x01, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x49, 0xA7, 0xA8, 0x5C, 0x57,
            0x4A, 0xD3, 0xBD, 0x4B, 0xD2, 0x0F, 0xF5, 0xE7, 0x74, 0x04,
        ];

        // str: 2087773917
        // bytecode: 1613377952

        let mut hasher = CityHasher::with_seed(0x20149F19);
        //hasher.write(b"TEXCOORD\0");
        hasher.write(&data);
        println!("{:x}", u64::from_be(hasher.finish() & 0x000000ffffffffff));

        let mut hasher = CityHasher::with_seed(2087773917);
        hasher.write(b"TEXCOORD\0");
        //hasher.write(&data);
        println!("{:x}", u64::from_be(hasher.finish() & 0x00007fffffffffff));
    }
}
